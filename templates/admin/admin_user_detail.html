{% extends "admin/admin_layout.html" %}
{% block content %}


<!-- ================= ADMIN HEADER CARD ================= -->
<div class="bg-white border border-slate-200 rounded-2xl 
            shadow-md p-6 mb-8">

    <div class="flex flex-col lg:flex-row 
                lg:items-center lg:justify-between gap-6">

        <!-- Left Side: User Info -->
        <div>
            <h1 class="text-2xl lg:text-3xl font-bold text-slate-800">
                {{ user.username }}
            </h1>
            <p class="text-sm text-slate-500 mt-1">
                User Activity Dashboard Overview
            </p>
        </div>

        <!-- Right Side: Action Buttons -->
        <div class="flex flex-wrap items-center gap-3">

            <!-- Export Button -->
            <a href="{{ url_for('export_user_activity_pdf', user_id=user.id) }}"
               class="group inline-flex items-center gap-2
                      bg-gradient-to-r from-purple-600 to-indigo-600
                      text-white px-5 py-2.5
                      rounded-xl shadow-lg shadow-purple-500/20
                      hover:from-purple-700 hover:to-indigo-700
                      transition-all duration-300
                      text-sm font-semibold">

                <i class="fa-solid fa-file-pdf 
                          group-hover:scale-110 transition-transform"></i>
                Export Full Predictions PDF
            </a>

            <!-- Back Button -->
            <a href="{{ request.referrer or url_for('admin_user_analytics') }}"
               class="inline-flex items-center gap-2
                      bg-slate-100 text-slate-700
                      px-4 py-2.5 rounded-xl
                      hover:bg-slate-200
                      transition text-sm font-medium">

                <i class="fa-solid fa-arrow-left text-xs"></i>
                Back
            </a>

        </div>

    </div>
</div>

<!-- ================= STATS CARDS ================= -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">

    <!-- Messages -->
    <div class="bg-white border border-slate-200 shadow-sm rounded-2xl p-6 hover:shadow-lg transition">
        <div class="flex justify-between items-center">
            <h2 class="text-slate-500 text-sm font-semibold">Total Messages</h2>
            <div class="bg-slate-100 p-2 rounded-xl">
                <i class="fa-solid fa-envelope text-slate-600 text-sm"></i>
            </div>
        </div>
        <p class="text-3xl font-bold mt-4">{{ messages }}</p>
        <button onclick="openModal('messagesModal')"
            class="mt-4 w-full bg-[#5b21b6] text-white py-2 rounded-xl text-sm font-semibold hover:bg-[#4c1d95] transition">
            <i class="fa-solid fa-eye text-xs"></i> View Details
        </button>
    </div>

    <!-- Clinical -->
    <div class="bg-white border border-emerald-100 shadow-sm rounded-2xl p-6 hover:shadow-lg transition">
        <div class="flex justify-between items-center">
            <h2 class="text-emerald-600 text-sm font-semibold">Reports Predictions</h2>
            <div class="bg-emerald-50 p-2 rounded-xl">
                <i class="fa-solid fa-file-medical text-emerald-600 text-sm"></i>
            </div>
        </div>
        <p class="text-3xl font-bold text-emerald-700 mt-4">{{ clinical }}</p>
        <button onclick="openModal('clinicalModal')"
            class="mt-4 w-full bg-[#5b21b6] text-white py-2 rounded-xl text-sm font-semibold hover:bg-[#4c1d95] transition">
            <i class="fa-solid fa-eye text-xs"></i> View Details
        </button>
    </div>

    <!-- Finger -->
    <div class="bg-white border border-cyan-100 shadow-sm rounded-2xl p-6 hover:shadow-lg transition">
        <div class="flex justify-between items-center">
            <h2 class="text-cyan-600 text-sm font-semibold">fingerprint Predictions</h2>
            <div class="bg-cyan-50 p-2 rounded-xl">
                <i class="fa-solid fa-fingerprint text-cyan-600 text-sm"></i>
            </div>
        </div>
        <p class="text-3xl font-bold text-cyan-700 mt-4">{{ finger }}</p>
        <button onclick="openModal('fingerModal')"
            class="mt-4 w-full bg-[#5b21b6] text-white py-2 rounded-xl text-sm font-semibold hover:bg-[#4c1d95] transition">
            <i class="fa-solid fa-eye text-xs"></i> View Details
        </button>
    </div>

    <!-- Combined -->
    <div class="bg-gradient-to-r from-[#5b21b6] to-[#7c3aed] text-white shadow-md rounded-2xl p-6 hover:shadow-xl transition">
        <div class="flex justify-between items-center">
            <h2 class="text-sm font-semibold text-indigo-100">Total Prediction Activity</h2>
            <div class="bg-white/20 p-2 rounded-xl">
                <i class="fa-solid fa-chart-line text-sm"></i>
            </div>
        </div>
        <p class="text-3xl font-bold mt-4">{{ total_predictions }}</p>
        <button onclick="openModal('combinedModal')"
            class="mt-4 w-full bg-white text-[#5b21b6] py-2 rounded-xl text-sm font-semibold hover:bg-gray-100 transition">
            <i class="fa-solid fa-eye text-xs"></i> View Details
        </button>
    </div>

</div>

<!-- ================= GRAPH ================= -->
<div class="bg-white shadow rounded-2xl p-6 mb-10">
    <h2 class="text-xl font-bold mb-6">Prediction Activity Graph</h2>
    <canvas id="activityChart"></canvas>
</div>

<!-- ================= MODALS ================= -->

<!-- Messages Modal -->
<div id="messagesModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
<div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden">
<div class="bg-[#5b21b6] text-white px-6 py-4 flex justify-between">
<h3 class="font-semibold">User Messages</h3>
<button onclick="closeModal('messagesModal')"><i class="fa-solid fa-xmark"></i></button>
</div>
<div class="p-6 max-h-[60vh] overflow-y-auto">
    {% for msg in messages_list %}
    <div class="border rounded-xl p-4 mb-3">
        <p><strong>Subject:</strong> {{ msg.subject }}</p>
        <p><strong>Messages:</strong> {{ msg.message }}</p>
    <p class="text-xs text-gray-500 mt-2">
    {{ msg.created_at }} |
    Status: {{ msg.status }} |
    Read: {{ "Yes" if msg.is_read else "No" }}
    </p>
    </div>
    {% else %}
    <p class="text-gray-500">No messages found.</p>
    {% endfor %}
</div>
</div>
</div>

<!-- Clinical Modal -->
<div id="clinicalModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
<div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden">
<div class="bg-[#5b21b6] text-white px-6 py-4 flex justify-between">
<h3 class="font-semibold">Reports Predictions</h3>
<button onclick="closeModal('clinicalModal')"><i class="fa-solid fa-xmark"></i></button>
</div>
<div class="p-6 max-h-[60vh] overflow-y-auto">
    {% for c in clinical_list %}
    <div class="border rounded-xl p-4 mb-3">
    <div class="grid grid-cols-2 gap-3 text-sm">
    <p><strong>Result:</strong> {{ c.result }}</p>
    <p><strong>Date:</strong> {{ c.created_at }}</p>
    <p><strong>Age:</strong> {{ c.age }}</p>
    <p><strong>BMI:</strong> {{ c.bmi }}</p>
    <p><strong>HbA1c:</strong> {{ c.hba1c }}</p>
    <p><strong>Glucose:</strong> {{ c.glucose }}</p>
    <p><strong>Gender:</strong> {{ c.gender_label }}</p>
    <p><strong>Smoking:</strong> {{ c.smoking_label }}</p>
    <p><strong>Hypertension:</strong> {{ c.hypertension_label }}</p>
    <p><strong>Heart Disease:</strong> {{ c.heart_label }}</p>
    </div>
    </div>
    <div class="flex gap-3 mb-6">
        <!-- Download PDF Button -->
        <a href="{{ url_for('admin_download_report', user_id=user.id) }}"
           class="flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg font-semibold text-sm 
                  hover:bg-red-200 hover:text-red-800 transition-colors">
            <i class="fa-solid fa-file-pdf text-lg"></i>
            Download PDF
        </a>
    
        <!-- Send Report via Email Button -->
        <a href="{{ url_for('admin_send_report_email', user_id=user.id) }}"
           class="flex items-center gap-2 px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold text-sm 
                  hover:bg-green-200 hover:text-green-800 transition-colors">
            <i class="fa-solid fa-paper-plane text-lg"></i>
            Send Report via Email
        </a>
    </div>
    
    
    {% else %}
    <p class="text-gray-500">No Reports records found.</p>
    {% endfor %}
</div>
</div>
</div>

<!-- Finger Modal -->
<div id="fingerModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
<div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden">
<div class="bg-[#5b21b6] text-white px-6 py-4 flex justify-between">
<h3 class="font-semibold">fingerprint Predictions</h3>
<button onclick="closeModal('fingerModal')"><i class="fa-solid fa-xmark"></i></button>
</div>
<div class="p-6 max-h-[60vh] overflow-y-auto">
    {% for f in finger_list %}
    <div class="border rounded-xl p-4 mb-3">
    <div class="grid grid-cols-2 gap-3 text-sm">
    <p><strong>Result:</strong> {{ f.result }}</p>
    <p><strong>Date:</strong> {{ f.created_at }}</p>
    <p><strong>Age:</strong> {{ f.age }}</p>
    <p><strong>BMI:</strong> {{ f.bmi }}</p>
    <p><strong>HbA1c:</strong> {{ f.hba1c }}</p>
    <p><strong>Glucose:</strong> {{ f.glucose }}</p>
    <p><strong>Gender:</strong> {{ f.gender_label }}</p>
    <p><strong>Smoking:</strong> {{ f.smoking_label }}</p>
    <p><strong>Ridge Density:</strong> {{ f.ridge_density }}</p>
    <p><strong>Complexity Score:</strong> {{ f.complexity_score }}</p>
    <p><strong>Pattern Type:</strong> {{ f.pattern_label }}</p>
    </div>
    </div>
    <div class="flex gap-3 mb-6">
        <!-- Download Fingerprint PDF -->
        <a href="{{ url_for('admin_download_finger_report', user_id=user.id) }}"
           class="flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg font-semibold text-sm 
                  hover:bg-red-200 hover:text-red-800 transition-colors">
            <i class="fa-solid fa-file-pdf text-lg"></i>
            Download PDF
        </a>
    
        <!-- Send Fingerprint Report via Email -->
        <a href="{{ url_for('admin_send_finger_report_email', user_id=user.id) }}"
           class="flex items-center gap-2 px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold text-sm 
                  hover:bg-green-200 hover:text-green-800 transition-colors">
            <i class="fa-solid fa-paper-plane text-lg"></i>
            Send Report via Email
        </a>
    </div>
    
    

    {% else %}
    <p class="text-gray-500">No fingerprint records found.</p>
    {% endfor %}
</div>
</div>
</div>

<!-- Combined Modal -->
<div id="combinedModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
<div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden">
<div class="bg-[#5b21b6] text-white px-6 py-4 flex justify-between">
<h3 class="font-semibold">All Predictions</h3>
<button onclick="closeModal('combinedModal')"><i class="fa-solid fa-xmark"></i></button>
</div>
<div class="p-6 max-h-[60vh] overflow-y-auto">
    {% for item in combined_list %}
    <div class="border rounded-xl p-4 mb-3 flex justify-between items-center">
    <div>
    <p class="font-semibold text-sm">{{ item.result }}</p>
    <p class="text-xs text-gray-500">{{ item.created_at }}</p>
    </div>
    <span class="px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-2
    {% if item.type == 'Reports' %}
        bg-emerald-100 text-emerald-800
    {% elif item.type == 'Finger' %}
        bg-cyan-100 text-cyan-800
    {% else %}
        bg-gray-100 text-gray-600
    {% endif %}
">
    {% if item.type == 'Reports' %}
        <i class="fa-solid fa-file-alt text-sm"></i>
    {% elif item.type == 'Finger' %}
        <i class="fa-solid fa-fingerprint text-sm"></i>
    {% else %}
    <i class="fa-solid fa-file-alt text-sm"></i>
    {% endif %}
    
    <span>{{ item.type }}</span>
</span>



    
    
    
    </div>
    {% else %}
    <p class="text-gray-500">No records found.</p>
    {% endfor %}
</div>
</div>
</div>

<!-- ================= JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
function closeModal(id){ document.getElementById(id).classList.add('hidden'); }

const labels = [{% for row in graph_data %}"{{ row.day }}",{% endfor %}];
const dataValues = [{% for row in graph_data %}{{ row.count }},{% endfor %}];

new Chart(document.getElementById('activityChart'), {
type: 'line',
data: {
labels: labels,
datasets: [{
label: 'Predictions per Day',
data: dataValues,
borderColor: '#5b21b6',
backgroundColor: 'rgba(91,33,182,0.1)',
borderWidth: 2,
tension: 0.4,
fill: true
}]
},
options: { responsive: true }
});
</script>

{% endblock %}
