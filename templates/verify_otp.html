{% extends "layout.html" %}

{% block content %}

<div class="flex items-center justify-center min-h-screen px-4 py-10 bg-slate-50">

    <!-- CARD -->
    <div class="auth-card mx-auto w-full max-w-[360px] sm:max-w-[380px] animate-fade-in
                bg-white/95 backdrop-blur-xl p-7 sm:p-8 rounded-3xl
                shadow-2xl shadow-slate-300/40 border border-slate-200">

        <!-- HEADER -->
        <div class="text-center mb-8">
            <div class="relative inline-block">
                <div class="bg-emerald-50 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4
                            border border-emerald-100/50 transition-transform hover:rotate-12">
                    <i class="fa-solid fa-shield-halved text-emerald-500 text-3xl"></i>
                </div>

                <div class="absolute -right-1 -bottom-1 w-5 h-5 bg-emerald-500 rounded-full
                            border-2 border-white flex items-center justify-center">
                    <i class="fa-solid fa-check text-white text-[9px]"></i>
                </div>
            </div>

            <h2 class="text-xl font-black text-slate-900 tracking-tight">
                OTP Verification
            </h2>

            <p class="text-[12px] text-slate-500 mt-2 font-medium px-2">
                We've sent a secure 6-digit code to your registered email
            </p>
        </div>

        <!-- TIMER BOX -->
        <div class="bg-slate-50/80 backdrop-blur-sm border border-slate-100
                    rounded-2xl p-4 mb-7 text-center">
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.25em] block mb-1">
                Security Window
            </span>

            <div id="otp-timer" class="text-xl font-mono font-black text-slate-800">
                {% if session.get('otp_invalid') %}
                    <span class="text-red-500">EXPIRED</span>
                {% else %}
                    05:00
                {% endif %}
            </div>
        </div>

        <!-- FORM -->
        <form action="{{ url_for('verify_otp') }}" method="POST" id="otpForm" class="space-y-6">

            <div class="space-y-2">
                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">
                    Enter Verification Code
                </label>

                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-fingerprint text-slate-300
                                  group-focus-within:text-emerald-500 transition-colors">
                        </i>
                    </div>

                    <input type="text"
                           name="otp"
                           id="otpInput"
                           required
                           maxlength="6"
                           pattern="\d{6}"
                           inputmode="numeric"
                           placeholder="0 0 0 0 0 0"
                           {% if session.get('otp_invalid') %}disabled{% endif %}
                           class="w-full pl-11 pr-4 py-3.5 rounded-xl border-2 border-slate-100
                                  text-center text-xl tracking-[0.45em] font-black text-slate-800
                                  focus:ring-0 focus:border-emerald-500 outline-none transition-all
                                  placeholder:text-slate-200 placeholder:tracking-normal
                                  {% if session.get('otp_invalid') %}bg-slate-50 opacity-60{% endif %}">
                </div>
            </div>

            <!-- BUTTON -->
            <button type="submit"
                    id="verifyBtn"
                    {% if session.get('otp_invalid') %}disabled{% endif %}
                    class="w-full bg-slate-900 text-white py-3.5 rounded-xl
                           font-bold text-xs tracking-widest shadow-xl shadow-slate-200
                           flex items-center justify-center gap-2
                           hover:bg-emerald-600 transition-all active:scale-[0.97]
                           {% if session.get('otp_invalid') %}opacity-40 cursor-not-allowed grayscale{% endif %}">

                <i class="fa-solid fa-unlock-keyhole"></i>
                VERIFY ACCOUNT
            </button>
        </form>

        <!-- RESEND -->
        <div class="text-center mt-8">
            <p class="text-[12px] text-slate-400 font-medium">
                Didn't receive the code?
            </p>

            <a href="{{ url_for('verify_otp', resend=1) }}"
               id="resendLink"
               class="inline-block mt-2 font-bold transition-all
                      text-[10px] uppercase tracking-wider
                      {% if session.get('otp_invalid') %}
                          text-emerald-600 hover:text-emerald-700 hover:underline
                      {% else %}
                          text-slate-300 pointer-events-none
                      {% endif %}">

                <i class="fa-solid fa-rotate-right mr-1"></i>
                Resend New Code
            </a>
        </div>

    </div>
</div>

{% if not session.get('otp_invalid') %}
<script>
let timeLeft = 300; // 5 minutes

const timerEl = document.getElementById("otp-timer");
const resendLink = document.getElementById("resendLink");
const verifyBtn = document.getElementById("verifyBtn");
const otpInput = document.getElementById("otpInput");

const timer = setInterval(() => {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;

    timerEl.textContent =
        `${minutes.toString().padStart(2,"0")}:${seconds.toString().padStart(2,"0")}`;

    if (timeLeft <= 0) {
        clearInterval(timer);

        timerEl.innerHTML = '<span class="text-red-500">EXPIRED</span>';

        otpInput.disabled = true;
        verifyBtn.disabled = true;
        verifyBtn.classList.add("opacity-50", "cursor-not-allowed");

        resendLink.classList.remove("pointer-events-none", "text-slate-300");
        resendLink.classList.add("text-emerald-600", "hover:underline");
    }

    timeLeft--;
}, 1000);
</script>
{% endif %}

{% endblock %}
